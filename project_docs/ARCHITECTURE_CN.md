# æ‚Ÿç©ºBot æ¶æ„æ–‡æ¡£

## ğŸ—ï¸ æ•´ä½“æ¶æ„

æ‚Ÿç©ºBot é‡‡ç”¨ **Gateway æ¨¡å¼ + æ’ä»¶åŒ–æ¶æ„**,æ ¸å¿ƒç»„ä»¶å¦‚ä¸‹:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IM å¹³å°å±‚                              â”‚
â”‚  é£ä¹¦ / ä¼ä¸šå¾®ä¿¡ / é’‰é’‰ / Telegram / Discord / Slack     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Channel æ’ä»¶å±‚                           â”‚
â”‚    ç»Ÿä¸€çš„ ChannelPlugin æ¥å£                              â”‚
â”‚    src/channels/plugins/ + extensions/                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Gateway ç½‘å…³å±‚                             â”‚
â”‚    WebSocket æ§åˆ¶å¹³é¢ (ws://127.0.0.1:18789)             â”‚
â”‚    è·¯ç”±ã€ä¼šè¯ç®¡ç†ã€å·¥å…·è°ƒåº¦                                â”‚
â”‚    src/gateway/                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                AI ä»£ç†å±‚                                  â”‚
â”‚    Pi Agent (åŸºäº @mariozechner/pi-coding-agent)         â”‚
â”‚    src/agents/                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å¤§æ¨¡å‹æä¾›å•†å±‚                              â”‚
â”‚    DeepSeek / åƒé—® / Kimi / è±†åŒ… / ç¡…åŸºæµåŠ¨              â”‚
â”‚    src/agents/models-config.ts                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ æ ¸å¿ƒç›®å½•ç»“æ„

```
wukongbot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ channels/           # é¢‘é“/IMå¹³å°æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ plugins/        # æ’ä»¶æ¥å£å’Œæ³¨å†Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts    # ChannelPlugin æ¥å£å®šä¹‰ â­ï¸
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts    # æ’ä»¶æ³¨å†Œè¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ onboarding/ # å„å¹³å°å¼•å¯¼é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ normalize/  # æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–
â”‚   â”‚   â”‚   â””â”€â”€ outbound/   # æ¶ˆæ¯å‘é€é€»è¾‘
â”‚   â”‚   â””â”€â”€ registry.ts     # é¢‘é“æ³¨å†Œå’ŒæŸ¥æ‰¾
â”‚   â”‚
â”‚   â”œâ”€â”€ telegram/           # Telegram å®ç°
â”‚   â”‚   â”œâ”€â”€ bot.ts          # Bot åˆ›å»ºå’Œé…ç½® â­ï¸
â”‚   â”‚   â”œâ”€â”€ bot-handlers.ts # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ discord/            # Discord å®ç°
â”‚   â”œâ”€â”€ slack/              # Slack å®ç°
â”‚   â”œâ”€â”€ signal/             # Signal å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ agents/             # AI ä»£ç†æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ models-config.ts           # æ¨¡å‹é…ç½®ç®¡ç† â­ï¸
â”‚   â”‚   â”œâ”€â”€ model-catalog.ts           # æ¨¡å‹ç›®å½• â­ï¸
â”‚   â”‚   â”œâ”€â”€ models-config.providers.ts # æä¾›å•†é…ç½® â­ï¸
â”‚   â”‚   â”œâ”€â”€ pi-embedded-runner/        # Pi Agent è¿è¡Œå™¨
â”‚   â”‚   â””â”€â”€ tools/                     # å·¥å…·å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ gateway/            # Gateway ç½‘å…³
â”‚   â”‚   â”œâ”€â”€ server.ts       # WebSocket æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ protocol/       # åè®®å®šä¹‰
â”‚   â”‚   â””â”€â”€ server-methods/ # RPC æ–¹æ³•
â”‚   â”‚
â”‚   â”œâ”€â”€ config/             # é…ç½®ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ types.ts        # é…ç½®ç±»å‹æ€»ç´¢å¼• â­ï¸
â”‚   â”‚   â”œâ”€â”€ config.ts       # é…ç½®åŠ è½½
â”‚   â”‚   â”œâ”€â”€ io.ts           # é…ç½®æ–‡ä»¶ I/O
â”‚   â”‚   â””â”€â”€ types.*.ts      # åˆ†æ¨¡å—ç±»å‹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/                # CLI å‘½ä»¤
â”‚   â”‚   â””â”€â”€ program.ts      # å‘½ä»¤è¡Œç¨‹åºå…¥å£
â”‚   â”‚
â”‚   â””â”€â”€ providers/          # æ¨¡å‹æä¾›å•† OAuth
â”‚       â”œâ”€â”€ github-copilot-auth.ts
â”‚       â”œâ”€â”€ qwen-portal-oauth.ts
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ extensions/             # æ‰©å±•æ’ä»¶ â­ï¸
â”‚   â”œâ”€â”€ msteams/           # Microsoft Teams
â”‚   â”œâ”€â”€ googlechat/        # Google Chat
â”‚   â”œâ”€â”€ matrix/            # Matrix
â”‚   â”œâ”€â”€ zalo/              # Zalo
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ docs/                  # æ–‡æ¡£
â””â”€â”€ ui/                    # Web UI
```

## ğŸ”Œ å¦‚ä½•æ·»åŠ æ–°çš„ IM å¹³å°

### æ–¹å¼ä¸€: ä½œä¸ºæ ¸å¿ƒ Channel(å†…ç½®)

1. **åˆ›å»ºç›®å½•ç»“æ„**
   ```
   src/feishu/
   â”œâ”€â”€ bot.ts              # Bot åˆ›å»ºå’Œé…ç½®
   â”œâ”€â”€ bot-handlers.ts     # æ¶ˆæ¯å¤„ç†
   â”œâ”€â”€ accounts.ts         # è´¦å·ç®¡ç†
   â”œâ”€â”€ types.ts            # ç±»å‹å®šä¹‰
   â””â”€â”€ ...
   ```

2. **å®ç°æ ¸å¿ƒé€»è¾‘** (`src/feishu/bot.ts`)
   ```typescript
   export function createFeishuBot(opts: FeishuBotOptions) {
     // 1. åˆå§‹åŒ– Feishu SDK
     // 2. æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
     // 3. å¤„ç†å…¥ç«™æ¶ˆæ¯
     // 4. è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
     // 5. è·¯ç”±åˆ° AI ä»£ç†
     return bot;
   }
   ```

3. **æ·»åŠ  Channel Plugin** (`src/channels/plugins/onboarding/feishu.ts`)
   ```typescript
   import type { ChannelPlugin } from "../types.js";
   
   export const feishuPlugin: ChannelPlugin = {
     id: "feishu",
     meta: {
       name: "é£ä¹¦",
       order: 10,
     },
     // å®ç°å¿…éœ€çš„æ¥å£æ–¹æ³•
     async onboard(config, runtime, prompter) { /* ... */ },
     async probe(config) { /* ... */ },
     async send(message, config) { /* ... */ },
     // ...
   };
   ```

4. **æ³¨å†Œæ’ä»¶** (`src/channels/plugins/index.ts`)
   ```typescript
   import { feishuPlugin } from "./onboarding/feishu.js";
   
   // åœ¨é€‚å½“ä½ç½®æ³¨å†Œ
   ```

5. **æ·»åŠ é…ç½®ç±»å‹** (`src/config/types.feishu.ts`)
   ```typescript
   export type FeishuConfig = {
     appId: string;
     appSecret: string;
     allowFrom?: string[];
     // ...
   };
   ```

6. **æ·»åŠ åˆ°ä¸»é…ç½®** (`src/config/types.ts`)
   ```typescript
   export type ChannelsConfig = {
     // ... å…¶ä»–å¹³å°
     feishu?: FeishuConfig;
   };
   ```

### æ–¹å¼äºŒ: ä½œä¸ºæ‰©å±•æ’ä»¶(æ¨èç”¨äºå¿«é€Ÿå¼€å‘)

1. **åˆ›å»ºæ‰©å±•ç›®å½•**
   ```
   extensions/feishu/
   â”œâ”€â”€ clawdbot.plugin.json   # æ’ä»¶å…ƒæ•°æ®
   â”œâ”€â”€ package.json            # ä¾èµ–ç®¡ç†
   â”œâ”€â”€ index.ts                # æ’ä»¶å…¥å£
   â””â”€â”€ src/
       â”œâ”€â”€ channel.ts          # Channel å®ç°
       â”œâ”€â”€ runtime.ts          # è¿è¡Œæ—¶é€»è¾‘
       â””â”€â”€ ...
   ```

2. **å®šä¹‰æ’ä»¶å…ƒæ•°æ®** (`clawdbot.plugin.json`)
   ```json
   {
     "id": "feishu",
     "version": "1.0.0",
     "name": "é£ä¹¦é›†æˆ",
     "description": "é£ä¹¦/Lark IM å¹³å°é›†æˆ",
     "author": "WukongBot Team",
     "type": "channel"
   }
   ```

3. **å®ç°æ’ä»¶æ¥å£** (`index.ts`)
   ```typescript
   import type { PluginApi } from "clawdbot/plugin-sdk";
   
   export default {
     id: "feishu",
     register(api: PluginApi) {
       api.registerChannel({
         id: "feishu",
         meta: { name: "é£ä¹¦", order: 10 },
         // å®ç°æ¥å£
       });
     },
   };
   ```

4. **å‚è€ƒç°æœ‰æ‰©å±•**
   - Microsoft Teams: `extensions/msteams/`
   - Google Chat: `extensions/googlechat/`
   - Matrix: `extensions/matrix/`

## ğŸ¤– å¦‚ä½•æ·»åŠ æ–°çš„å¤§æ¨¡å‹æä¾›å•†

### 1. åˆ›å»ºæä¾›å•†é…ç½® (`src/agents/models-config.providers.ts`)

```typescript
export async function resolveImplicitDeepSeekProvider(params: {
  agentDir: string;
}): Promise<ProviderConfig | null> {
  const apiKey = process.env.DEEPSEEK_API_KEY;
  if (!apiKey) return null;
  
  return {
    apiKey,
    baseUrl: "https://api.deepseek.com",
    models: [
      { id: "deepseek-chat", name: "DeepSeek Chat" },
      { id: "deepseek-coder", name: "DeepSeek Coder" },
    ],
  };
}
```

### 2. åœ¨ `resolveImplicitProviders` ä¸­æ³¨å†Œ

```typescript
export async function resolveImplicitProviders(params: {
  agentDir: string;
}): Promise<Record<string, ProviderConfig>> {
  const providers: Record<string, ProviderConfig> = {};
  
  // ... å…¶ä»–æä¾›å•†
  
  const deepseek = await resolveImplicitDeepSeekProvider(params);
  if (deepseek) providers["deepseek"] = deepseek;
  
  return providers;
}
```

### 3. æ·»åŠ  OAuth æ”¯æŒ(å¯é€‰)

å¦‚æœæ¨¡å‹éœ€è¦ OAuth è®¤è¯,åœ¨ `src/providers/` åˆ›å»º:

```typescript
// src/providers/deepseek-oauth.ts
export async function authenticateDeepSeek(params: {
  clientId: string;
  redirectUri: string;
}): Promise<{ accessToken: string }> {
  // å®ç° OAuth æµç¨‹
}
```

### 4. é…ç½®æ¨¡å‹

ç”¨æˆ·é…ç½®æ–‡ä»¶ (`~/.clawdbot/wukongbot.json`):

```json5
{
  models: {
    providers: {
      deepseek: {
        apiKey: "sk-xxx",
        baseUrl: "https://api.deepseek.com",
        models: [
          { id: "deepseek-chat", name: "DeepSeek Chat" }
        ]
      }
    }
  },
  agent: {
    model: "deepseek/deepseek-chat"
  }
}
```

## ğŸ”§ å…³é”®æ¥å£è¯´æ˜

### ChannelPlugin æ¥å£

```typescript
export type ChannelPlugin = {
  id: ChannelId;
  meta: {
    name: string;
    order?: number;
  };
  
  // å¼•å¯¼é…ç½®
  onboard(
    config: MoltbotConfig,
    runtime: RuntimeEnv,
    prompter: Prompter
  ): Promise<MoltbotConfig>;
  
  // æ¢æµ‹çŠ¶æ€
  probe(config: MoltbotConfig): Promise<ProbeResult>;
  
  // å‘é€æ¶ˆæ¯
  send(
    message: OutboundMessage,
    config: MoltbotConfig
  ): Promise<void>;
  
  // å¯åŠ¨ç›‘æ§
  monitor?(
    config: MoltbotConfig,
    runtime: RuntimeEnv
  ): Promise<MonitorHandle>;
};
```

### ProviderConfig æ¥å£

```typescript
export type ProviderConfig = {
  apiKey?: string;
  baseUrl?: string;
  models: Array<{
    id: string;
    name?: string;
    contextWindow?: number;
    reasoning?: boolean;
    input?: Array<"text" | "image">;
  }>;
};
```

## ğŸ“ å¼€å‘æµç¨‹

### 1. å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/yourusername/wukongbot.git
cd wukongbot

# å®‰è£…ä¾èµ–
pnpm install

# æ„å»º
pnpm build

# å¼€å‘æ¨¡å¼(è‡ªåŠ¨é‡è½½)
pnpm gateway:watch
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
pnpm test src/channels/plugins/

# æµ‹è¯•è¦†ç›–ç‡
pnpm test:coverage
```

### 3. ä»£ç è§„èŒƒ

```bash
# ä»£ç æ£€æŸ¥
pnpm lint

# ä»£ç æ ¼å¼åŒ–
pnpm format
```

### 4. æäº¤ä»£ç 

```bash
# ä½¿ç”¨æäº¤åŠ©æ‰‹
./scripts/committer "feat: æ·»åŠ é£ä¹¦é›†æˆ" src/feishu/

# æˆ–æ‰‹åŠ¨æäº¤
git add .
git commit -m "feat: æ·»åŠ é£ä¹¦é›†æˆ"
```

## ğŸ¯ å›½äº§åŒ–å¼€å‘ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µ: IM å¹³å°é›†æˆ
1. **é£ä¹¦** - ä¼ä¸šç”¨æˆ·æœ€å¤š,API æ–‡æ¡£å®Œå–„
2. **ä¼ä¸šå¾®ä¿¡** - ä¼ä¸šå¸‚åœºé‡è¦å¹³å°
3. **é’‰é’‰** - ä¸­å°ä¼ä¸šå¹¿æ³›ä½¿ç”¨

### ç¬¬äºŒé˜¶æ®µ: å¤§æ¨¡å‹é›†æˆ
1. âœ… **DeepSeek** - å·²æ”¯æŒ,æ€§ä»·æ¯”é«˜
2. âœ… **åƒé—®(Qwen)** - å·²æ”¯æŒ,é˜¿é‡Œäº‘ç”Ÿæ€
3. âœ… **Kimi** - å·²æ”¯æŒ,é•¿ä¸Šä¸‹æ–‡å¼º
4. âœ… **è±†åŒ…** - å·²æ”¯æŒ,å­—èŠ‚è·³åŠ¨
5. âœ… **ç¡…åŸºæµåŠ¨** - å·²æ”¯æŒ,æ¨¡å‹èšåˆå¹³å°
6. **æ™ºè°±(GLM)** - å¾…æ”¯æŒ
7. **ç™¾å·** - å¾…æ”¯æŒ

### ç¬¬ä¸‰é˜¶æ®µ: ç®€åŒ–å®‰è£…
1. ä¸€é”®å®‰è£…è„šæœ¬
2. Docker é•œåƒ
3. Web ç®¡ç†ç•Œé¢
4. ä¸­æ–‡æ–‡æ¡£å®Œå–„

## ğŸ“š å‚è€ƒèµ„æº

### IM å¹³å° API æ–‡æ¡£
- [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/document)
- [ä¼ä¸šå¾®ä¿¡ API](https://developer.work.weixin.qq.com/)
- [é’‰é’‰å¼€æ”¾å¹³å°](https://open.dingtalk.com/)

### å¤§æ¨¡å‹ API æ–‡æ¡£
- [DeepSeek API](https://platform.deepseek.com/docs)
- [åƒé—® API](https://help.aliyun.com/zh/dashscope/)
- [Kimi API](https://platform.moonshot.cn/docs)
- [è±†åŒ… API](https://www.volcengine.com/docs/82379)
- [ç¡…åŸºæµåŠ¨](https://docs.siliconflow.cn/)

### ç°æœ‰ä»£ç å‚è€ƒ
- Telegram: `src/telegram/bot.ts`
- Discord: `src/discord/`
- Teams: `extensions/msteams/`
- Model Config: `src/agents/models-config.ts`

## ğŸ¤ è´¡çŒ®æŒ‡å—

è¯¦è§ [CONTRIBUTING.md](CONTRIBUTING.md)

æ¬¢è¿æäº¤ Issue å’Œ Pull Request!
